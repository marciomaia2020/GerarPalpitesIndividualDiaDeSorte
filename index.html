<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Inteligente - Dia de Sorte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ds-green': '#00A859',
                        'ds-yellow': '#FFD700',
                        'ds-dark-green': '#008A47',
                        'ds-light-green': '#4CAF50'
                    }
                }
            }
        }
    </script>
    <style>
        .number-btn {
            transition: all 0.3s ease;
        }
        .number-btn:hover {
            transform: scale(1.05);
        }
        .selected {
            background: linear-gradient(45deg, #00A859, #FFD700);
            color: white;
            font-weight: bold;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .highlight-last-draw {
            box-shadow: 0 0 0 2px #FF6B6B;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .stats-card {
            background: linear-gradient(135deg, rgba(0, 168, 89, 0.1), rgba(255, 215, 0, 0.1));
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-ds-green to-ds-yellow text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-2xl md:text-3xl font-bold text-center">üçÄ Gerador Inteligente - Dia de Sorte</h1>
            <p class="text-center mt-2 opacity-90">An√°lise em tempo real ‚Ä¢ Fechamentos otimizados ‚Ä¢ 7 n√∫meros de 1 a 31</p>
        </div>
    </header>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- API Status -->
        <div id="apiStatus" class="mb-4 p-3 rounded-lg hidden">
            <div class="flex items-center gap-2">
                <div class="loading w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                <span>Carregando dados dos sorteios...</span>
            </div>
        </div>

        <!-- Last Draw Info -->
        <div id="lastDrawInfo" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6 hidden">
            <h3 class="text-lg font-semibold text-ds-green mb-3">üìä √öltimo Sorteio</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Concurso:</p>
                    <p id="lastConcurso" class="font-bold text-lg"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Data:</p>
                    <p id="lastData" class="font-bold text-lg"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">N√∫meros sorteados:</p>
                    <div id="lastNumbers" class="flex flex-wrap gap-1 mt-1"></div>
                </div>
            </div>
            <label class="flex items-center gap-2 mt-3">
                <input type="checkbox" id="useLastNumbers" class="w-4 h-4 text-ds-green">
                <span class="text-sm">Incluir n√∫meros do √∫ltimo sorteio na sele√ß√£o</span>
            </label>
        </div>

        <!-- Statistics Cards -->
        <div id="statisticsSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hidden">
            <div class="stats-card p-4 rounded-lg">
                <h4 class="font-semibold text-ds-green mb-2">üî• Mais Frequentes</h4>
                <div id="mostFrequent" class="flex flex-wrap gap-1"></div>
                <button id="useMostFrequent" class="mt-2 px-3 py-1 bg-ds-green text-white rounded text-sm hover:bg-ds-dark-green">
                    Usar estes n√∫meros
                </button>
            </div>
            <div class="stats-card p-4 rounded-lg">
                <h4 class="font-semibold text-ds-green mb-2">‚ùÑÔ∏è Menos Frequentes</h4>
                <div id="leastFrequent" class="flex flex-wrap gap-1"></div>
                <button id="useLeastFrequent" class="mt-2 px-3 py-1 bg-ds-yellow text-black rounded text-sm hover:bg-yellow-600">
                    Usar estes n√∫meros
                </button>
            </div>
            <div class="stats-card p-4 rounded-lg">
                <h4 class="font-semibold text-ds-green mb-2">‚ö° Mais Atrasados</h4>
                <div id="mostDelayed" class="flex flex-wrap gap-1"></div>
                <button id="useMostDelayed" class="mt-2 px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600">
                    Usar estes n√∫meros
                </button>
            </div>
            <div class="stats-card p-4 rounded-lg">
                <h4 class="font-semibold text-ds-green mb-2">üéØ Sequ√™ncias Quentes</h4>
                <div id="hotSequences" class="text-sm"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Number Selection -->
            <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-ds-green mb-4">üéØ Sele√ß√£o de N√∫meros</h2>
                
                <!-- Quick Actions -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="clearAll" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                        Limpar Tudo
                    </button>
                    <button id="selectPairs" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        S√≥ Pares
                    </button>
                    <button id="selectOdds" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">
                        S√≥ √çmpares
                    </button>
                    <button id="selectRandom" class="px-3 py-1 bg-ds-green text-white rounded text-sm hover:bg-ds-dark-green">
                        15 Aleat√≥rios
                    </button>
                </div>

                <!-- Number Grid -->
                <div class="grid grid-cols-5 sm:grid-cols-7 lg:grid-cols-8 gap-1 sm:gap-2 mb-4">
                    <!-- Numbers 1-31 will be generated by JavaScript -->
                </div>

                <!-- Selection Info -->
                <div id="selectionInfo" class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <span id="selectedCount">Selecionados: 0</span>
                        <span id="pairCount">Pares: 0</span>
                        <span id="oddCount">√çmpares: 0</span>
                        <span id="rangeInfo">Intervalo: -</span>
                    </div>
                </div>
            </div>

            <!-- Generation Settings -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-ds-green mb-4">‚öôÔ∏è Configura√ß√µes</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Quantidade de Jogos:</label>
                        <input type="number" id="numGames" value="10" min="1" max="100" 
                               class="w-full px-3 py-2 border rounded-lg text-base focus:ring-2 focus:ring-ds-green">
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label class="block text-sm font-medium">Dezenas por Jogo:</label>
                            <button id="helpButton" class="text-ds-green hover:text-ds-dark-green text-sm underline" title="Guia de estrat√©gia">
                                üìñ Como escolher?
                            </button>
                        </div>
                        <select id="numbersPerGame" class="w-full px-3 py-2 border rounded-lg text-base focus:ring-2 focus:ring-ds-green">
                            <option value="7">7 n√∫meros (m√≠nimo)</option>
                            <option value="8">8 n√∫meros</option>
                            <option value="9">9 n√∫meros</option>
                            <option value="10">10 n√∫meros</option>
                            <option value="11">11 n√∫meros</option>
                            <option value="12">12 n√∫meros</option>
                            <option value="13">13 n√∫meros</option>
                            <option value="14">14 n√∫meros</option>
                            <option value="15">15 n√∫meros (m√°ximo)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Estrat√©gia:</label>
                        <select id="strategy" class="w-full px-3 py-2 border rounded-lg text-base focus:ring-2 focus:ring-ds-green">
                            <option value="balanced">Equilibrada</option>
                            <option value="hot">N√∫meros Quentes</option>
                            <option value="cold">N√∫meros Frios</option>
                            <option value="mixed">Mista (Quentes + Frios)</option>
                            <option value="sequential">Sequencial</option>
                            <option value="random">Totalmente Aleat√≥ria</option>
                        </select>
                    </div>

                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="avoidLastDraw" class="w-4 h-4 text-ds-green">
                            <span class="text-sm">Evitar n√∫meros do √∫ltimo sorteio</span>
                        </label>
                    </div>

                    <button id="generateGames" class="w-full bg-gradient-to-r from-ds-green to-ds-yellow text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">
                        üé≤ Gerar Fechamentos
                    </button>
                </div>
            </div>
        </div>

        <!-- Generated Games -->
        <div id="generatedGames" class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hidden">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                <h2 class="text-xl font-semibold text-ds-green">üéØ Jogos Gerados</h2>
                <div class="flex flex-wrap gap-2">
                    <button id="downloadTxt" class="flex-1 sm:flex-none px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">
                        üìÑ TXT
                    </button>
                    <button id="downloadHtml" class="flex-1 sm:flex-none px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                        üåê HTML
                    </button>
                    <button id="downloadXlsx" class="flex-1 sm:flex-none px-3 py-2 bg-ds-green text-white rounded hover:bg-ds-dark-green text-sm">
                        üìä XLSX
                    </button>
                </div>
            </div>

            <!-- Game Analysis -->
            <div id="gameAnalysis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"></div>

            <!-- Games List -->
            <div id="gamesList" class="space-y-2"></div>
        </div>
    </div>

    <script>
        let selectedNumbers = new Set();
        let lastDrawNumbers = [];
        let allDrawsData = [];
        let numberFrequency = {};
        let numberLastAppearance = {};
        let generatedGames = [];

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeNumberGrid();
            loadLotteryData();
            setupEventListeners();
        });

        function initializeNumberGrid() {
            const container = document.querySelector('.grid.grid-cols-5');
            container.innerHTML = '';
            
            for (let i = 1; i <= 31; i++) {
                const button = document.createElement('button');
                button.className = 'number-btn w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-ds-green text-xs sm:text-sm font-semibold hover:bg-ds-green hover:text-white transition-all touch-manipulation';
                button.textContent = i.toString().padStart(2, '0');
                button.onclick = () => toggleNumber(i);
                container.appendChild(button);
            }
        }

        function toggleNumber(num) {
            const button = document.querySelector(`.grid button:nth-child(${num})`);
            
            if (selectedNumbers.has(num)) {
                selectedNumbers.delete(num);
                button.classList.remove('selected');
                button.classList.add('border-2', 'border-ds-green');
            } else {
                if (selectedNumbers.size < 31) {
                    selectedNumbers.add(num);
                    button.classList.add('selected');
                    button.classList.remove('border-2', 'border-ds-green');
                }
            }
            
            updateSelectionInfo();
        }

        function updateSelectionInfo() {
            const selected = Array.from(selectedNumbers);
            const pairs = selected.filter(n => n % 2 === 0).length;
            const odds = selected.filter(n => n % 2 === 1).length;
            const min = selected.length > 0 ? Math.min(...selected) : 0;
            const max = selected.length > 0 ? Math.max(...selected) : 0;

            document.getElementById('selectedCount').textContent = `Selecionados: ${selected.length}`;
            document.getElementById('pairCount').textContent = `Pares: ${pairs}`;
            document.getElementById('oddCount').textContent = `√çmpares: ${odds}`;
            document.getElementById('rangeInfo').textContent = selected.length > 0 ? `Intervalo: ${min}-${max}` : 'Intervalo: -';
        }

        async function loadLotteryData() {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.className = 'mb-4 p-3 rounded-lg bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';

            try {
                // Simulating API call - In real implementation, you would call the Caixa API
                // For now, let's create some realistic sample data
                await simulateAPICall();
                
                statusDiv.classList.add('hidden');
                displayLastDraw();
                calculateStatistics();
                displayStatistics();
                
            } catch (error) {
                statusDiv.className = 'mb-4 p-3 rounded-lg bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                statusDiv.innerHTML = '<span>‚ùå Erro ao carregar dados dos sorteios. Usando dados de exemplo.</span>';
                
                // Use sample data as fallback
                createSampleData();
                displayLastDraw();
                calculateStatistics();
                displayStatistics();
            }
        }

        async function simulateAPICall() {
            try {
                // Busca o √∫ltimo concurso do Dia de Sorte
                const response = await fetch('https://servicebus2.caixa.gov.br/portaldeloterias/api/diadesorte/');
                
                if (!response.ok) {
                    throw new Error('Erro na API da Caixa');
                }
                
                const data = await response.json();
                
                // Processa os dados do √∫ltimo concurso
                const lastDraw = {
                    concurso: data.numero,
                    data: data.dataApuracao,
                    dezenas: data.listaDezenas.map(num => parseInt(num))
                };
                
                // Busca hist√≥rico dos √∫ltimos sorteios
                await loadHistoricalData(lastDraw.concurso);
                
                // Define os n√∫meros do √∫ltimo sorteio
                lastDrawNumbers = lastDraw.dezenas;
                
                // Adiciona o √∫ltimo sorteio ao hist√≥rico se n√£o estiver
                if (!allDrawsData.some(draw => draw.concurso === lastDraw.concurso)) {
                    allDrawsData.push(lastDraw);
                }
                
            } catch (error) {
                console.error('Erro ao buscar dados da API:', error);
                // Fallback para dados simulados em caso de erro
                createSampleData();
            }
        }

        async function loadHistoricalData(lastConcurso) {
            try {
                allDrawsData = [];
                
                // Busca os √∫ltimos 50 concursos para an√°lise estat√≠stica
                const promises = [];
                for (let i = 0; i < 50; i++) {
                    const concursoNum = lastConcurso - i;
                    if (concursoNum > 0) {
                        promises.push(fetchConcurso(concursoNum));
                    }
                }
                
                const results = await Promise.allSettled(promises);
                
                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        allDrawsData.push(result.value);
                    }
                });
                
                // Ordena por n√∫mero do concurso (mais antigo primeiro)
                allDrawsData.sort((a, b) => a.concurso - b.concurso);
                
                // Se n√£o conseguiu buscar dados suficientes, preenche com simulados
                if (allDrawsData.length < 10) {
                    console.warn('Poucos dados reais encontrados, complementando com simulados');
                    createSampleData();
                }
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                createSampleData();
            }
        }

        async function fetchConcurso(numero) {
            try {
                const response = await fetch(`https://servicebus2.caixa.gov.br/portaldeloterias/api/diadesorte/${numero}`);
                
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                
                return {
                    concurso: data.numero,
                    data: data.dataApuracao,
                    dezenas: data.listaDezenas.map(num => parseInt(num))
                };
                
            } catch (error) {
                return null;
            }
        }

        function createSampleData() {
            // Fallback: Generate sample data if API fails
            allDrawsData = [];
            for (let i = 0; i < 50; i++) {
                const numbers = [];
                while (numbers.length < 7) {
                    const num = Math.floor(Math.random() * 31) + 1;
                    if (!numbers.includes(num)) {
                        numbers.push(num);
                    }
                }
                numbers.sort((a, b) => a - b);
                
                const date = new Date();
                date.setDate(date.getDate() - i * 3);
                
                allDrawsData.push({
                    concurso: 1108 - i,
                    data: date.toLocaleDateString('pt-BR'),
                    dezenas: numbers
                });
            }
            
            allDrawsData.reverse();
            lastDrawNumbers = allDrawsData[allDrawsData.length - 1].dezenas;
        }

        function displayLastDraw() {
            const lastDraw = allDrawsData[allDrawsData.length - 1];
            document.getElementById('lastConcurso').textContent = lastDraw.concurso;
            document.getElementById('lastData').textContent = lastDraw.data;
            
            // Calculate unique digits for the last draw
            const lastDrawDigitCount = calculateGameDigits(lastDraw.dezenas);
            
            const numbersContainer = document.getElementById('lastNumbers');
            numbersContainer.innerHTML = '';
            lastDraw.dezenas.forEach(num => {
                const span = document.createElement('span');
                span.className = 'px-2 py-1 bg-ds-green text-white rounded text-sm font-bold';
                span.textContent = num.toString().padStart(2, '0');
                numbersContainer.appendChild(span);
            });
            
            // Add digit count display
            const digitCountSpan = document.createElement('span');
            digitCountSpan.className = 'px-2 py-1 bg-blue-600 text-white rounded text-sm font-bold ml-2';
            digitCountSpan.textContent = `${lastDrawDigitCount}d`;
            digitCountSpan.title = 'D√≠gitos √∫nicos usados no √∫ltimo sorteio';
            numbersContainer.appendChild(digitCountSpan);
            
            document.getElementById('lastDrawInfo').classList.remove('hidden');
        }

        function calculateStatistics() {
            numberFrequency = {};
            numberLastAppearance = {};
            
            // Initialize
            for (let i = 1; i <= 31; i++) {
                numberFrequency[i] = 0;
                numberLastAppearance[i] = 0;
            }
            
            // Calculate frequency and last appearance
            allDrawsData.forEach((draw, index) => {
                draw.dezenas.forEach(num => {
                    numberFrequency[num]++;
                    numberLastAppearance[num] = allDrawsData.length - index;
                });
            });
        }

        function displayStatistics() {
            // Most frequent numbers
            const mostFrequent = Object.entries(numberFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 7)
                .map(([num]) => parseInt(num));
            
            displayNumberGroup('mostFrequent', mostFrequent, 'bg-red-500');
            
            // Least frequent numbers
            const leastFrequent = Object.entries(numberFrequency)
                .sort((a, b) => a[1] - b[1])
                .slice(0, 7)
                .map(([num]) => parseInt(num));
            
            displayNumberGroup('leastFrequent', leastFrequent, 'bg-blue-500');
            
            // Most delayed numbers
            const mostDelayed = Object.entries(numberLastAppearance)
                .sort((a, b) => a[1] - b[1])
                .slice(0, 7)
                .map(([num]) => parseInt(num));
            
            displayNumberGroup('mostDelayed', mostDelayed, 'bg-orange-500');
            
            // Hot sequences
            const sequences = findHotSequences();
            document.getElementById('hotSequences').innerHTML = sequences;
            
            document.getElementById('statisticsSection').classList.remove('hidden');
        }

        function displayNumberGroup(containerId, numbers, bgClass) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            numbers.forEach(num => {
                const span = document.createElement('span');
                span.className = `px-2 py-1 ${bgClass} text-white rounded text-sm font-bold`;
                span.textContent = num.toString().padStart(2, '0');
                container.appendChild(span);
            });
        }

        function findHotSequences() {
            // Simple analysis of consecutive numbers
            const sequences = [];
            const recentDraws = allDrawsData.slice(-10);
            
            for (let i = 1; i <= 29; i++) {
                let count = 0;
                recentDraws.forEach(draw => {
                    if (draw.dezenas.includes(i) && draw.dezenas.includes(i + 1)) {
                        count++;
                    }
                });
                if (count >= 2) {
                    sequences.push(`${i}-${i + 1} (${count}x)`);
                }
            }
            
            return sequences.length > 0 ? sequences.join(', ') : 'Nenhuma sequ√™ncia detectada';
        }

        function setupEventListeners() {
            // Quick selection buttons
            document.getElementById('clearAll').onclick = () => {
                selectedNumbers.clear();
                initializeNumberGrid();
                updateSelectionInfo();
            };
            
            document.getElementById('selectPairs').onclick = () => {
                selectedNumbers.clear();
                for (let i = 2; i <= 30; i += 2) {
                    selectedNumbers.add(i);
                }
                updateNumberGridVisual();
                updateSelectionInfo();
            };
            
            document.getElementById('selectOdds').onclick = () => {
                selectedNumbers.clear();
                for (let i = 1; i <= 31; i += 2) {
                    selectedNumbers.add(i);
                }
                updateNumberGridVisual();
                updateSelectionInfo();
            };
            
            document.getElementById('selectRandom').onclick = () => {
                selectedNumbers.clear();
                while (selectedNumbers.size < 15) {
                    selectedNumbers.add(Math.floor(Math.random() * 31) + 1);
                }
                updateNumberGridVisual();
                updateSelectionInfo();
            };
            
            // Statistics quick select
            document.getElementById('useMostFrequent').onclick = () => useStatisticsNumbers('mostFrequent');
            document.getElementById('useLeastFrequent').onclick = () => useStatisticsNumbers('leastFrequent');
            document.getElementById('useMostDelayed').onclick = () => useStatisticsNumbers('mostDelayed');
            
            // Use last draw numbers
            document.getElementById('useLastNumbers').onchange = (e) => {
                if (e.target.checked) {
                    lastDrawNumbers.forEach(num => selectedNumbers.add(num));
                    updateNumberGridVisual();
                    updateSelectionInfo();
                }
            };
            
            // Generate games
            document.getElementById('generateGames').onclick = generateGames;
            
            // Download buttons
            document.getElementById('downloadTxt').onclick = () => downloadGames('txt');
            document.getElementById('downloadHtml').onclick = () => downloadGames('html');
            document.getElementById('downloadXlsx').onclick = () => downloadGames('xlsx');
            
            // Help button
            document.getElementById('helpButton').onclick = showStrategyModal;
        }

        function updateNumberGridVisual() {
            const buttons = document.querySelectorAll('.number-btn');
            buttons.forEach((button, index) => {
                const num = index + 1;
                if (selectedNumbers.has(num)) {
                    button.classList.add('selected');
                    button.classList.remove('border-2', 'border-ds-green');
                } else {
                    button.classList.remove('selected');
                    button.classList.add('border-2', 'border-ds-green');
                }
            });
            // For√ßa atualiza√ß√£o das informa√ß√µes de sele√ß√£o
            updateSelectionInfo();
        }

        function syncGridWithSelection() {
            // Verifica se h√° inconsist√™ncias entre o grid visual e o Set selectedNumbers
            const buttons = document.querySelectorAll('.number-btn');
            const visuallySelected = [];
            
            buttons.forEach((button, index) => {
                const num = index + 1;
                if (button.classList.contains('selected')) {
                    visuallySelected.push(num);
                }
            });
            
            // Recria o Set baseado no que est√° visualmente selecionado
            selectedNumbers.clear();
            visuallySelected.forEach(num => selectedNumbers.add(num));
            
            // Atualiza as informa√ß√µes
            updateSelectionInfo();
        }

        function useStatisticsNumbers(type) {
            const container = document.getElementById(type);
            const numbers = Array.from(container.children).map(span => 
                parseInt(span.textContent)
            );
            
            selectedNumbers.clear();
            numbers.forEach(num => selectedNumbers.add(num));
            updateNumberGridVisual();
            updateSelectionInfo();
        }

        function generateGames() {
            // Sincroniza o grid com a sele√ß√£o antes de gerar
            syncGridWithSelection();
            
            if (selectedNumbers.size < 7) {
                showCustomAlert('Selecione pelo menos 7 n√∫meros para gerar os jogos.');
                return;
            }
            
            const numGames = parseInt(document.getElementById('numGames').value);
            const numbersPerGame = parseInt(document.getElementById('numbersPerGame').value);
            const strategy = document.getElementById('strategy').value;
            const avoidLastDraw = document.getElementById('avoidLastDraw').checked;
            
            // Se evitar n√∫meros do √∫ltimo sorteio, filtra os n√∫meros selecionados
            let availableNumbers = Array.from(selectedNumbers);
            if (avoidLastDraw) {
                availableNumbers = availableNumbers.filter(num => !lastDrawNumbers.includes(num));
                if (availableNumbers.length < numbersPerGame) {
                    showCustomAlert(`Para evitar n√∫meros do √∫ltimo sorteio, voc√™ precisa selecionar pelo menos ${numbersPerGame} n√∫meros que n√£o estejam no √∫ltimo sorteio. Selecione mais n√∫meros ou desmarque a op√ß√£o.`);
                    return;
                }
            }
            
            generatedGames = [];
            const gameSet = new Set(); // Para evitar jogos duplicados
            let attempts = 0;
            const maxAttempts = numGames * 50; // Limite de tentativas para evitar loop infinito
            
            while (generatedGames.length < numGames && attempts < maxAttempts) {
                attempts++;
                let gameNumbers;
                
                switch (strategy) {
                    case 'hot':
                        gameNumbers = generateHotNumbers(availableNumbers, numbersPerGame);
                        break;
                    case 'cold':
                        gameNumbers = generateColdNumbers(availableNumbers, numbersPerGame);
                        break;
                    case 'mixed':
                        gameNumbers = generateMixedNumbers(availableNumbers, numbersPerGame);
                        break;
                    case 'sequential':
                        gameNumbers = generateSequentialNumbers(availableNumbers, numbersPerGame);
                        break;
                    case 'random':
                        gameNumbers = generateRandomNumbers(availableNumbers, numbersPerGame);
                        break;
                    default: // balanced
                        gameNumbers = generateBalancedNumbers(availableNumbers, numbersPerGame);
                }
                
                const sortedGame = gameNumbers.sort((a, b) => a - b);
                const gameKey = sortedGame.join('-');
                
                // S√≥ adiciona se o jogo for √∫nico
                if (!gameSet.has(gameKey)) {
                    gameSet.add(gameKey);
                    generatedGames.push(sortedGame);
                }
            }
            
            if (generatedGames.length < numGames) {
                showCustomAlert(`Foram gerados ${generatedGames.length} jogos √∫nicos de ${numGames} solicitados. Para gerar mais jogos √∫nicos, selecione mais n√∫meros ou reduza a quantidade de jogos.`);
            }
            
            displayGeneratedGames();
        }

        function generateHotNumbers(selected, count) {
            const hotNumbers = selected
                .map(num => ({ num, freq: numberFrequency[num] }))
                .sort((a, b) => b.freq - a.freq);
            
            // Seleciona uma por√ß√£o aleat√≥ria dos n√∫meros mais quentes (70-100% dos top n√∫meros)
            const topCount = Math.max(count, Math.floor(hotNumbers.length * 0.7));
            const topHotNumbers = hotNumbers.slice(0, topCount);
            
            // Embaralha e seleciona n√∫meros aleatoriamente dos mais quentes
            const shuffledHot = topHotNumbers.sort(() => Math.random() - 0.5);
            const result = [];
            
            // Garante pelo menos 60% de n√∫meros realmente quentes
            const minHot = Math.ceil(count * 0.6);
            for (let i = 0; i < Math.min(minHot, shuffledHot.length); i++) {
                result.push(shuffledHot[i].num);
            }
            
            // Completa com n√∫meros aleat√≥rios dos selecionados
            while (result.length < count) {
                const remaining = selected.filter(n => !result.includes(n));
                if (remaining.length === 0) break;
                result.push(remaining[Math.floor(Math.random() * remaining.length)]);
            }
            
            return result;
        }

        function generateColdNumbers(selected, count) {
            const coldNumbers = selected
                .map(num => ({ num, freq: numberFrequency[num] }))
                .sort((a, b) => a.freq - b.freq);
            
            // Seleciona uma por√ß√£o aleat√≥ria dos n√∫meros mais frios (70-100% dos bottom n√∫meros)
            const topCount = Math.max(count, Math.floor(coldNumbers.length * 0.7));
            const topColdNumbers = coldNumbers.slice(0, topCount);
            
            // Embaralha e seleciona n√∫meros aleatoriamente dos mais frios
            const shuffledCold = topColdNumbers.sort(() => Math.random() - 0.5);
            const result = [];
            
            // Garante pelo menos 60% de n√∫meros realmente frios
            const minCold = Math.ceil(count * 0.6);
            for (let i = 0; i < Math.min(minCold, shuffledCold.length); i++) {
                result.push(shuffledCold[i].num);
            }
            
            // Completa com n√∫meros aleat√≥rios dos selecionados
            while (result.length < count) {
                const remaining = selected.filter(n => !result.includes(n));
                if (remaining.length === 0) break;
                result.push(remaining[Math.floor(Math.random() * remaining.length)]);
            }
            
            return result;
        }

        function generateMixedNumbers(selected, count) {
            const hotNumbers = selected
                .map(num => ({ num, freq: numberFrequency[num] }))
                .sort((a, b) => b.freq - a.freq);
            const coldNumbers = selected
                .map(num => ({ num, freq: numberFrequency[num] }))
                .sort((a, b) => a.freq - b.freq);
            
            // Varia a propor√ß√£o entre quentes e frios para cada jogo
            const hotRatio = 0.3 + Math.random() * 0.4; // Entre 30% e 70%
            const hotCount = Math.floor(count * hotRatio);
            const coldCount = count - hotCount;
            
            const result = [];
            
            // Adiciona n√∫meros quentes aleat√≥rios
            const topHot = hotNumbers.slice(0, Math.max(hotCount * 2, 5));
            const shuffledHot = topHot.sort(() => Math.random() - 0.5);
            for (let i = 0; i < Math.min(hotCount, shuffledHot.length); i++) {
                result.push(shuffledHot[i].num);
            }
            
            // Adiciona n√∫meros frios aleat√≥rios
            const topCold = coldNumbers.slice(0, Math.max(coldCount * 2, 5));
            const shuffledCold = topCold.filter(item => !result.includes(item.num)).sort(() => Math.random() - 0.5);
            for (let i = 0; i < Math.min(coldCount, shuffledCold.length); i++) {
                result.push(shuffledCold[i].num);
            }
            
            // Completa com n√∫meros aleat√≥rios se necess√°rio
            while (result.length < count) {
                const remaining = selected.filter(n => !result.includes(n));
                if (remaining.length === 0) break;
                result.push(remaining[Math.floor(Math.random() * remaining.length)]);
            }
            
            return result;
        }

        function generateSequentialNumbers(selected, count) {
            const sorted = [...selected].sort((a, b) => a - b);
            const result = [];
            
            // Varia entre sequ√™ncia cont√≠nua e sequ√™ncia com pequenos saltos
            const sequenceType = Math.random() < 0.6 ? 'continuous' : 'stepped';
            
            if (sequenceType === 'continuous' && sorted.length >= count) {
                // Sequ√™ncia cont√≠nua aleat√≥ria
                const maxStart = sorted.length - count;
                const start = Math.floor(Math.random() * (maxStart + 1));
                
                for (let i = 0; i < count; i++) {
                    result.push(sorted[start + i]);
                }
            } else {
                // Sequ√™ncia com pequenos saltos ou quando n√£o h√° n√∫meros suficientes
                const step = Math.max(1, Math.floor(sorted.length / count));
                const start = Math.floor(Math.random() * step);
                
                for (let i = 0; i < count && start + (i * step) < sorted.length; i++) {
                    result.push(sorted[start + (i * step)]);
                }
                
                // Preenche o restante aleatoriamente se necess√°rio
                while (result.length < count) {
                    const remaining = selected.filter(n => !result.includes(n));
                    if (remaining.length === 0) break;
                    result.push(remaining[Math.floor(Math.random() * remaining.length)]);
                }
            }
            
            return result;
        }

        function generateRandomNumbers(selected, count) {
            const shuffled = [...selected].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        function generateBalancedNumbers(selected, count) {
            const pairs = selected.filter(n => n % 2 === 0);
            const odds = selected.filter(n => n % 2 === 1);
            
            // Varia a propor√ß√£o de pares/√≠mpares para cada jogo (40-60%)
            const pairRatio = 0.4 + Math.random() * 0.2; // Entre 40% e 60%
            const targetPairs = Math.floor(count * pairRatio);
            const targetOdds = count - targetPairs;
            
            const result = [];
            
            // Considera tamb√©m frequ√™ncia dos n√∫meros para o equil√≠brio
            const balancedPairs = pairs.map(num => ({
                num,
                score: numberFrequency[num] + Math.random() * 5 // Adiciona aleatoriedade √† frequ√™ncia
            })).sort((a, b) => b.score - a.score);
            
            const balancedOdds = odds.map(num => ({
                num,
                score: numberFrequency[num] + Math.random() * 5 // Adiciona aleatoriedade √† frequ√™ncia
            })).sort((a, b) => b.score - a.score);
            
            // Seleciona pares de forma semi-aleat√≥ria
            const shuffledPairs = balancedPairs.sort(() => Math.random() - 0.5);
            for (let i = 0; i < Math.min(targetPairs, shuffledPairs.length); i++) {
                result.push(shuffledPairs[i].num);
            }
            
            // Seleciona √≠mpares de forma semi-aleat√≥ria
            const shuffledOdds = balancedOdds.sort(() => Math.random() - 0.5);
            for (let i = 0; i < Math.min(targetOdds, shuffledOdds.length); i++) {
                result.push(shuffledOdds[i].num);
            }
            
            // Preenche o restante com n√∫meros aleat√≥rios
            while (result.length < count) {
                const remaining = selected.filter(n => !result.includes(n));
                if (remaining.length === 0) break;
                result.push(remaining[Math.floor(Math.random() * remaining.length)]);
            }
            
            return result;
        }

        function displayGeneratedGames() {
            const container = document.getElementById('generatedGames');
            const analysisContainer = document.getElementById('gameAnalysis');
            const gamesListContainer = document.getElementById('gamesList');
            
            // Calculate analysis
            const totalGames = generatedGames.length;
            const totalCost = calculateTotalCost();
            const avgPairs = generatedGames.reduce((sum, game) => 
                sum + game.filter(n => n % 2 === 0).length, 0) / totalGames;
            const hasLastDrawNumbers = generatedGames.some(game => 
                lastDrawNumbers.some(num => game.includes(num)));
            
            // Calculate digit frequency
            const digitCount = calculateDigitFrequency();
            const mostUsedDigits = Object.entries(digitCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([digit, count]) => `${digit}(${count}x)`)
                .join(' ');
            
            const leastUsedDigits = Object.entries(digitCount)
                .sort((a, b) => a[1] - b[1])
                .slice(0, 3)
                .map(([digit, count]) => `${digit}(${count}x)`)
                .join(' ');

            // Display analysis
            analysisContainer.innerHTML = `
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-ds-green">${totalGames}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Jogos Gerados</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-ds-green">R$ ${totalCost.toFixed(2)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Custo Total</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-ds-green">${avgPairs.toFixed(1)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">M√©dia Pares/Jogo</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold ${hasLastDrawNumbers ? 'text-red-500' : 'text-gray-500'}">${hasLastDrawNumbers ? 'SIM' : 'N√ÉO'}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">N√∫meros do √öltimo Sorteio</div>
                    ${hasLastDrawNumbers ? `
                        <button onclick="replaceAllLastDrawNumbers()" class="mt-2 px-3 py-1 bg-orange-500 text-white rounded text-xs hover:bg-orange-600 font-semibold" title="Trocar n√∫meros do √∫ltimo sorteio de TODOS os jogos">
                            üîÑ Trocar Todos
                        </button>
                    ` : ''}
                </div>
            `;
            

            
            // Display games list
            gamesListContainer.innerHTML = '';
            generatedGames.forEach((game, index) => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700';
                
                const pairs = game.filter(n => n % 2 === 0).length;
                const odds = game.filter(n => n % 2 === 1).length;
                const range = `${Math.min(...game)}-${Math.max(...game)}`;
                const hasLastDraw = lastDrawNumbers.some(num => game.includes(num));
                
                // Calculate unique digits for this game
                const gameDigitCount = calculateGameDigits(game);
                const lastDrawDigitCount = calculateGameDigits(lastDrawNumbers);
                const isEqualToLastDraw = gameDigitCount === lastDrawDigitCount;
                
                gameDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-ds-green">Jogo ${index + 1}:</span>
                            <div class="flex items-center gap-2">
                                <div class="text-xs text-gray-500 flex gap-3">
                                    <span>P: ${pairs}</span>
                                    <span>I: ${odds}</span>
                                    <span class="hidden sm:inline">Range: ${range}</span>
                                    <span class="font-bold ${isEqualToLastDraw ? 'text-red-600' : 'text-blue-600'}" title="${isEqualToLastDraw ? 'Igual ao √∫ltimo sorteio!' : 'D√≠gitos √∫nicos usados'}">${gameDigitCount}d${isEqualToLastDraw ? ' ‚ö†Ô∏è' : ''}</span>
                                </div>
                                ${hasLastDraw ? `<button onclick="replaceLastDrawNumbers(${index})" class="px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600" title="Trocar n√∫meros do √∫ltimo sorteio">üîÑ Trocar</button>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1" id="game-numbers-${index}">
                            ${game.map(num => {
                                const isFromLastDraw = lastDrawNumbers.includes(num);
                                return `<span class="px-2 py-1 rounded text-sm font-bold ${isFromLastDraw ? 'highlight-last-draw bg-red-100 text-red-800' : 'bg-ds-green text-white'}">${num.toString().padStart(2, '0')}</span>`;
                            }).join('')}
                        </div>
                        ${hasLastDraw ? '<div class="text-xs text-red-600 font-bold">‚ö†Ô∏è Cont√©m n√∫meros do √∫ltimo sorteio</div>' : ''}
                        <div class="text-xs text-gray-500 sm:hidden">
                            <span>Range: ${range}</span>
                        </div>
                    </div>
                `;
                
                gamesListContainer.appendChild(gameDiv);
            });
            
            container.classList.remove('hidden');
        }

        function calculateTotalCost() {
            const numbersPerGame = parseInt(document.getElementById('numbersPerGame').value);
            // Dia de Sorte prices (2024 values - approximate)
            const prices = {
                7: 2.00, 8: 16.00, 9: 72.00, 10: 240.00,
                11: 660.00, 12: 1584.00, 13: 3432.00,
                14: 6864.00, 15: 12870.00
            };
            
            return generatedGames.length * (prices[numbersPerGame] || 2.00);
        }

        function downloadGames(format) {
            // Sincroniza antes de baixar para garantir consist√™ncia
            syncGridWithSelection();
            
            const numbersPerGame = parseInt(document.getElementById('numbersPerGame').value);
            const costPerGame = calculateTotalCost() / generatedGames.length;
            
            switch (format) {
                case 'txt':
                    downloadTxt();
                    break;
                case 'html':
                    downloadHtml();
                    break;
                case 'xlsx':
                    downloadXlsx();
                    break;
            }
        }

        function downloadTxt() {
            try {
                let content = '';
                
                // Adiciona apenas os n√∫meros dos jogos, um jogo por linha
                generatedGames.forEach((game, index) => {
                    content += `${game.map(n => n.toString().padStart(2, '0')).join(' ')}\n`;
                });
                
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dia-de-sorte-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showCustomAlert('‚úÖ Arquivo TXT baixado com sucesso!');
            } catch (error) {
                console.error('Erro ao baixar TXT:', error);
                showCustomAlert('‚ùå Erro ao baixar arquivo TXT. Tente novamente.');
            }
        }

        function downloadHtml() {
            // Gera o conte√∫do HTML dos jogos separadamente para evitar template literals aninhados
            const gamesHtml = generatedGames.map((game, index) => {
                const numbersHtml = game.map(num => 
                    `<span class="number">${num.toString().padStart(2, '0')}</span>`
                ).join('');
                
                const pairs = game.filter(n => n % 2 === 0).length;
                const odds = game.filter(n => n % 2 === 1).length;
                
                return `
        <div class="game">
            <strong>Jogo ${index + 1}:</strong>
            ${numbersHtml}
            <span style="float: right; color: #666;">
                Pares: ${pairs} | √çmpares: ${odds}
            </span>
        </div>`;
            }).join('');

            const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dia de Sorte - Fechamentos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: linear-gradient(45deg, #00A859, #FFD700); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .game { padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .number { display: inline-block; background: #00A859; color: white; padding: 8px 10px; margin: 3px; border-radius: 50%; font-weight: bold; min-width: 30px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .stats { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 24px; }
        h3 { color: #00A859; margin-bottom: 15px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; }
        .info-item { background: #f8f9fa; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üçÄ Dia de Sorte - Fechamentos Gerados</h1>
        <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
    </div>
    
    <div class="stats">
        <h3>üìä Informa√ß√µes dos Jogos</h3>
        <div class="info-grid">
            <div class="info-item"><strong>Total de jogos:</strong> ${generatedGames.length}</div>
            <div class="info-item"><strong>Dezenas por jogo:</strong> ${document.getElementById('numbersPerGame').value}</div>
            <div class="info-item"><strong>Custo total:</strong> R$ ${calculateTotalCost().toFixed(2)}</div>
            <div class="info-item"><strong>Estrat√©gia:</strong> ${document.getElementById('strategy').options[document.getElementById('strategy').selectedIndex].text}</div>
        </div>
        <div style="margin-top: 15px;">
            <strong>N√∫meros selecionados:</strong> ${Array.from(selectedNumbers).sort((a,b) => a-b).join(', ')}
        </div>
    </div>
    
    <h3>üéØ Jogos Gerados:</h3>
    ${gamesHtml}
    
    <div style="text-align: center; margin-top: 30px; padding: 20px; background: white; border-radius: 8px; border: 1px solid #ddd;">
        <p style="color: #666; margin: 0;">
            <strong>üçÄ Boa sorte!</strong><br>
            Gerado pelo Gerador Inteligente - Dia de Sorte
        </p>
    </div>
</body>
</html>`;
            
            try {
                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dia-de-sorte-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showCustomAlert('‚úÖ Arquivo HTML baixado com sucesso!');
            } catch (error) {
                console.error('Erro ao baixar HTML:', error);
                showCustomAlert('‚ùå Erro ao baixar arquivo HTML. Tente novamente.');
            }
        }

        function downloadXlsx() {
            try {
                if (typeof XLSX === 'undefined') {
                    showCustomAlert('‚ùå Biblioteca XLSX n√£o carregada. Recarregue a p√°gina e tente novamente.');
                    return;
                }

                const wb = XLSX.utils.book_new();
                
                // Games sheet
                const wsData = [
                    ['Jogo', 'N√∫meros', 'Pares', '√çmpares', 'Menor', 'Maior', 'Amplitude', 'D√≠gitos √önicos'],
                    ...generatedGames.map((game, index) => [
                        index + 1,
                        game.map(n => n.toString().padStart(2, '0')).join(' '),
                        game.filter(n => n % 2 === 0).length,
                        game.filter(n => n % 2 === 1).length,
                        Math.min(...game),
                        Math.max(...game),
                        Math.max(...game) - Math.min(...game),
                        calculateGameDigits(game) + 'd'
                    ])
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Styling the header row
                const headerRange = XLSX.utils.decode_range(ws['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "00A859" } },
                        alignment: { horizontal: "center" }
                    };
                }
                
                XLSX.utils.book_append_sheet(wb, ws, 'Jogos');
                
                // Summary sheet
                const summaryData = [
                    ['üìä RESUMO DOS JOGOS GERADOS', ''],
                    ['', ''],
                    ['Informa√ß√£o', 'Valor'],
                    ['Data de Gera√ß√£o', new Date().toLocaleString('pt-BR')],
                    ['Total de Jogos', generatedGames.length],
                    ['Dezenas por Jogo', document.getElementById('numbersPerGame').value],
                    ['Estrat√©gia Utilizada', document.getElementById('strategy').options[document.getElementById('strategy').selectedIndex].text],
                    ['Custo Total', `R$ ${calculateTotalCost().toFixed(2)}`],
                    ['Custo por Jogo', `R$ ${(calculateTotalCost() / generatedGames.length).toFixed(2)}`],
                    ['', ''],
                    ['N√öMEROS SELECIONADOS:', ''],
                    ['Quantidade', selectedNumbers.size],
                    ['Lista', Array.from(selectedNumbers).sort((a,b) => a-b).join(', ')],
                    ['', ''],
                    ['ESTAT√çSTICAS:', ''],
                    ['M√©dia Pares/Jogo', (generatedGames.reduce((sum, game) => sum + game.filter(n => n % 2 === 0).length, 0) / generatedGames.length).toFixed(1)],
                    ['M√©dia √çmpares/Jogo', (generatedGames.reduce((sum, game) => sum + game.filter(n => n % 2 === 1).length, 0) / generatedGames.length).toFixed(1)],
                    ['Tem n√∫meros do √∫ltimo sorteio?', generatedGames.some(game => lastDrawNumbers.some(num => game.includes(num))) ? 'SIM' : 'N√ÉO']
                ];
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumo');
                
                // Analysis sheet with number frequency
                const analysisData = [
                    ['AN√ÅLISE DE FREQU√äNCIA DOS N√öMEROS SELECIONADOS', ''],
                    ['', ''],
                    ['N√∫mero', 'Apari√ß√µes nos Jogos', 'Frequ√™ncia %']
                ];
                
                // Count frequency of each selected number in generated games
                const numberUsage = {};
                selectedNumbers.forEach(num => numberUsage[num] = 0);
                
                generatedGames.forEach(game => {
                    game.forEach(num => {
                        if (numberUsage.hasOwnProperty(num)) {
                            numberUsage[num]++;
                        }
                    });
                });
                
                Array.from(selectedNumbers).sort((a,b) => a-b).forEach(num => {
                    const frequency = ((numberUsage[num] / generatedGames.length) * 100).toFixed(1);
                    analysisData.push([num.toString().padStart(2, '0'), numberUsage[num], frequency + '%']);
                });
                
                const wsAnalysis = XLSX.utils.aoa_to_sheet(analysisData);
                XLSX.utils.book_append_sheet(wb, wsAnalysis, 'An√°lise');
                
                const fileName = `dia-de-sorte-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showCustomAlert('‚úÖ Arquivo XLSX baixado com sucesso!');
            } catch (error) {
                console.error('Erro ao baixar XLSX:', error);
                showCustomAlert('‚ùå Erro ao baixar arquivo XLSX. Verifique se seu navegador suporta downloads ou tente outro formato.');
            }
        }

        function replaceAllLastDrawNumbers() {
            // Identifica todos os jogos que cont√™m n√∫meros do √∫ltimo sorteio
            const gamesWithLastDraw = [];
            generatedGames.forEach((game, index) => {
                const hasLastDraw = lastDrawNumbers.some(num => game.includes(num));
                if (hasLastDraw) {
                    gamesWithLastDraw.push(index);
                }
            });
            
            if (gamesWithLastDraw.length === 0) {
                showCustomAlert('Nenhum jogo cont√©m n√∫meros do √∫ltimo sorteio.');
                return;
            }
            
            // Verifica se h√° n√∫meros suficientes dispon√≠veis para todas as trocas
            const totalNumbersToReplace = gamesWithLastDraw.reduce((total, gameIndex) => {
                const game = generatedGames[gameIndex];
                return total + game.filter(num => lastDrawNumbers.includes(num)).length;
            }, 0);
            
            const availableNumbers = Array.from(selectedNumbers).filter(num => 
                !lastDrawNumbers.includes(num)
            );
            
            if (availableNumbers.length === 0) {
                showCustomAlert('N√£o h√° n√∫meros dispon√≠veis para trocar. Selecione mais n√∫meros que n√£o sejam do √∫ltimo sorteio.');
                return;
            }
            
            let successfulReplacements = 0;
            let skippedGames = 0;
            
            // Processa cada jogo individualmente
            gamesWithLastDraw.forEach(gameIndex => {
                const currentGame = generatedGames[gameIndex];
                const numbersFromLastDraw = currentGame.filter(num => lastDrawNumbers.includes(num));
                
                // Encontra n√∫meros dispon√≠veis que n√£o est√£o no jogo atual
                const gameAvailableNumbers = availableNumbers.filter(num => 
                    !currentGame.includes(num)
                );
                
                if (gameAvailableNumbers.length >= numbersFromLastDraw.length) {
                    // H√° n√∫meros suficientes para este jogo
                    const shuffledAvailable = [...gameAvailableNumbers].sort(() => Math.random() - 0.5);
                    let newGame = [...currentGame];
                    
                    numbersFromLastDraw.forEach((oldNum, index) => {
                        if (index < shuffledAvailable.length) {
                            const newNum = shuffledAvailable[index];
                            const oldNumIndex = newGame.indexOf(oldNum);
                            newGame[oldNumIndex] = newNum;
                        }
                    });
                    
                    // Ordena o novo jogo
                    newGame.sort((a, b) => a - b);
                    
                    // Atualiza o jogo no array
                    generatedGames[gameIndex] = newGame;
                    
                    // Atualiza a visualiza√ß√£o deste jogo espec√≠fico
                    updateGameDisplay(gameIndex);
                    
                    successfulReplacements++;
                } else {
                    skippedGames++;
                }
            });
            
            // Mostra resultado da opera√ß√£o
            let message = '';
            if (successfulReplacements > 0) {
                message += `‚úÖ ${successfulReplacements} jogo(s) tiveram n√∫meros do √∫ltimo sorteio substitu√≠dos.`;
            }
            if (skippedGames > 0) {
                if (message) message += '\n\n';
                message += `‚ö†Ô∏è ${skippedGames} jogo(s) n√£o puderam ser alterados por falta de n√∫meros dispon√≠veis para substitui√ß√£o.`;
            }
            
            showCustomAlert(message);
            
            // Atualiza as estat√≠sticas gerais
            updateGeneralStats();
        }

        function replaceLastDrawNumbers(gameIndex) {
            const currentGame = generatedGames[gameIndex];
            const numbersFromLastDraw = currentGame.filter(num => lastDrawNumbers.includes(num));
            
            if (numbersFromLastDraw.length === 0) {
                return; // Nenhum n√∫mero do √∫ltimo sorteio para trocar
            }
            
            // Encontra n√∫meros dispon√≠veis que n√£o est√£o no jogo atual e n√£o s√£o do √∫ltimo sorteio
            const availableNumbers = Array.from(selectedNumbers).filter(num => 
                !currentGame.includes(num) && !lastDrawNumbers.includes(num)
            );
            
            if (availableNumbers.length < numbersFromLastDraw.length) {
                showCustomAlert('N√£o h√° n√∫meros suficientes dispon√≠veis para trocar. Selecione mais n√∫meros que n√£o sejam do √∫ltimo sorteio.');
                return;
            }
            
            // Substitui cada n√∫mero do √∫ltimo sorteio por um n√∫mero dispon√≠vel
            let newGame = [...currentGame];
            numbersFromLastDraw.forEach((oldNum, index) => {
                if (index < availableNumbers.length) {
                    const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                    const newNum = availableNumbers.splice(randomIndex, 1)[0];
                    
                    const oldNumIndex = newGame.indexOf(oldNum);
                    newGame[oldNumIndex] = newNum;
                }
            });
            
            // Ordena o novo jogo
            newGame.sort((a, b) => a - b);
            
            // Atualiza o jogo no array
            generatedGames[gameIndex] = newGame;
            
            // Atualiza a visualiza√ß√£o deste jogo espec√≠fico
            updateGameDisplay(gameIndex);
        }

        function updateGameDisplay(gameIndex) {
            const game = generatedGames[gameIndex];
            const gameContainer = document.getElementById(`game-numbers-${gameIndex}`);
            
            if (!gameContainer) return;
            
            const pairs = game.filter(n => n % 2 === 0).length;
            const odds = game.filter(n => n % 2 === 1).length;
            const hasLastDraw = lastDrawNumbers.some(num => game.includes(num));
            
            // Atualiza os n√∫meros
            gameContainer.innerHTML = game.map(num => {
                const isFromLastDraw = lastDrawNumbers.includes(num);
                return `<span class="px-2 py-1 rounded text-sm font-bold ${isFromLastDraw ? 'highlight-last-draw bg-red-100 text-red-800' : 'bg-ds-green text-white'}">${num.toString().padStart(2, '0')}</span>`;
            }).join('');
            
            // Atualiza as informa√ß√µes do jogo (pares/√≠mpares)
            const gameDiv = gameContainer.closest('.p-3');
            const statsDiv = gameDiv.querySelector('.text-xs.text-gray-500');
            if (statsDiv) {
                const range = `${Math.min(...game)}-${Math.max(...game)}`;
                statsDiv.innerHTML = `
                    <span>P: ${pairs}</span>
                    <span>I: ${odds}</span>
                    <span class="hidden sm:inline">Range: ${range}</span>
                `;
            }
            
            // Remove ou adiciona o bot√£o de trocar conforme necess√°rio
            const existingButton = gameDiv.querySelector('button[onclick*="replaceLastDrawNumbers"]');
            const warningDiv = gameDiv.querySelector('.text-red-600');
            
            if (!hasLastDraw) {
                // Remove o bot√£o e o aviso se n√£o h√° mais n√∫meros do √∫ltimo sorteio
                if (existingButton) existingButton.remove();
                if (warningDiv) warningDiv.remove();
            }
            
            // Atualiza as estat√≠sticas gerais
            updateGeneralStats();
        }

        function updateGeneralStats() {
            const analysisContainer = document.getElementById('gameAnalysis');
            if (!analysisContainer) return;
            
            const totalGames = generatedGames.length;
            const totalCost = calculateTotalCost();
            const avgPairs = generatedGames.reduce((sum, game) => 
                sum + game.filter(n => n % 2 === 0).length, 0) / totalGames;
            const hasLastDrawNumbers = generatedGames.some(game => 
                lastDrawNumbers.some(num => game.includes(num)));
            
            analysisContainer.innerHTML = `
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-ds-green">${totalGames}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Jogos Gerados</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-ds-green">R$ ${totalCost.toFixed(2)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Custo Total</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-ds-green">${avgPairs.toFixed(1)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">M√©dia Pares/Jogo</div>
                </div>
                <div class="stats-card p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold ${hasLastDrawNumbers ? 'text-red-500' : 'text-gray-500'}">${hasLastDrawNumbers ? 'SIM' : 'N√ÉO'}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">N√∫meros do √öltimo Sorteio</div>
                </div>
            `;
        }

        function calculateDigitFrequency() {
            const digitCount = {
                '0': 0, '1': 0, '2': 0, '3': 0, '4': 0,
                '5': 0, '6': 0, '7': 0, '8': 0, '9': 0
            };
            
            // Conta cada d√≠gito em todos os n√∫meros dos jogos
            generatedGames.forEach(game => {
                game.forEach(number => {
                    const numberStr = number.toString().padStart(2, '0');
                    // Conta cada d√≠gito do n√∫mero (ex: 01 = d√≠gitos 0 e 1)
                    for (let digit of numberStr) {
                        digitCount[digit]++;
                    }
                });
            });
            
            return digitCount;
        }

        function calculateGameDigits(gameNumbers) {
            const uniqueDigits = new Set();
            
            gameNumbers.forEach(number => {
                const numberStr = number.toString().padStart(2, '0');
                // Adiciona cada d√≠gito do n√∫mero ao Set (automaticamente remove duplicatas)
                for (let digit of numberStr) {
                    uniqueDigits.add(digit);
                }
            });
            
            return uniqueDigits.size;
        }

        function showStrategyModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-gradient-to-r from-ds-green to-ds-yellow text-white p-6 rounded-t-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">üìñ</span>
                                <h2 class="text-xl font-bold">Guia de Estrat√©gia - Quantas Dezenas Escolher?</h2>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
                        </div>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg border-l-4 border-blue-500">
                            <p class="text-gray-700 dark:text-gray-300">
                                <strong>Boa pergunta üëå</strong><br><br>
                                No Dia de Sorte voc√™ aposta de 7 a 15 dezenas dentre as 31 dispon√≠veis.<br>
                                A escolha da quantidade depende do seu objetivo no fechamento (garantir m√≠nimo de acertos com menor custo).
                            </p>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-ds-green mb-4 flex items-center gap-2">
                                üìå <span>Recomenda√ß√µes gerais:</span>
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg border border-red-200 dark:border-red-700">
                                    <h4 class="font-semibold text-red-700 dark:text-red-300 mb-2">üí∞ 7 dezenas (aposta simples):</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        Barato (R$ 2,50), mas n√£o permite fechamento. Serve apenas como aposta direta.
                                    </p>
                                </div>
                                
                                <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg border border-orange-200 dark:border-orange-700">
                                    <h4 class="font-semibold text-orange-700 dark:text-orange-300 mb-2">üìä 8 a 10 dezenas:</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        √â a faixa mais usada para fechamentos inteligentes porque ainda tem custo vi√°vel e permite garantir pr√™mios menores (ex.: 4 ou 5 pontos) em caso de acerto de um grupo maior.
                                    </p>
                                </div>
                                
                                <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg border border-yellow-200 dark:border-yellow-700">
                                    <h4 class="font-semibold text-yellow-700 dark:text-yellow-300 mb-2">üí™ 11 a 12 dezenas:</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        Boa para fechamentos mais fortes. Custo maior, mas a chance de pegar 6 ou 7 pontos aumenta bastante.
                                    </p>
                                </div>
                                
                                <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                                    <h4 class="font-semibold text-purple-700 dark:text-purple-300 mb-2">üí∏ 13 a 15 dezenas:</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        Muito caro (acima de R$ 6.000 a aposta cheia com 15). S√≥ vale se for bol√£o grande ou fechamento com filtros.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-ds-green to-ds-yellow p-6 rounded-lg text-white">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                ‚öñÔ∏è <span>Equil√≠brio recomendado:</span>
                            </h3>
                            <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                                <p class="mb-3">
                                    <strong>Para jogador individual ou pequenos grupos, trabalhar entre 9 e 11 dezenas √© o ideal</strong>, porque:
                                </p>
                                <ul class="space-y-2 list-disc list-inside">
                                    <li>‚úÖ D√° flexibilidade para montar fechamentos</li>
                                    <li>üí∞ Mant√©m o custo controlado</li>
                                    <li>üéØ Mant√©m boas chances de premia√ß√£o (principalmente 5, 6 e 7 pontos)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg border border-green-200 dark:border-green-700">
                            <h3 class="text-lg font-semibold text-green-700 dark:text-green-300 mb-3 flex items-center gap-2">
                                üëâ <span>Exemplo pr√°tico:</span>
                            </h3>
                            <p class="text-gray-700 dark:text-gray-300">
                                <strong>Fechamento com 9 dezenas</strong> pode gerar ~12 a 18 jogos de 7 dezenas cada e ainda 
                                <span class="bg-green-200 dark:bg-green-800 px-2 py-1 rounded">garantir 5 pontos caso acerte 7 do grupo</span>.
                            </p>
                        </div>

                        <div class="text-center pt-4">
                            <button onclick="this.closest('.fixed').remove()" class="bg-ds-green text-white px-6 py-3 rounded-lg font-semibold hover:bg-ds-dark-green transition-colors">
                                Entendi! Vamos jogar üéØ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-ds-yellow rounded-full flex items-center justify-center">
                            <span class="text-xl">‚ö†Ô∏è</span>
                        </div>
                        <h3 class="font-semibold text-lg">Aten√ß√£o</h3>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-ds-green text-white hover:bg-ds-dark-green rounded" onclick="this.closest('.fixed').remove()">
                            Entendi
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>